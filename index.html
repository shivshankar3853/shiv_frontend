<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Trading Service Control</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2422/2422796.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2422/2422796.png">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --primary: #ffffff; /* Replaced green with white for black theme */
            --secondary: #333333;
            --bg-body: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            --bg-card: #111111;
            --bg-input: #1a1a1a;
            --bg-list: #1a1a1a;
            --text-main: #ffffff;
            --text-dim: #999999;
            --text-details: #666666;
            --danger: #ff4d4d;
            --success: #ffffff;
            --shadow: rgba(0,0,0,0.8);
            --border: rgba(255,255,255,0.1);
            --accent: #ffffff;
        }

        [data-theme="light"] {
            --primary: #000000;
            --secondary: #e9ecef;
            --bg-body: linear-gradient(135deg, #f4f7f6 0%, #e9ecef 100%);
            --bg-card: #ffffff;
            --bg-input: #f8f9fa;
            --bg-list: #f8f9fa;
            --text-main: #1a1a2e;
            --text-dim: #555;
            --text-details: #888;
            --shadow: rgba(0,0,0,0.1);
            --border: rgba(0,0,0,0.05);
            --accent: #000000;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
            box-sizing: border-box;
            transition: background 0.3s, color 0.3s;
        }

        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px var(--shadow);
            z-index: 1000;
            font-size: 20px;
            transition: transform 0.2s;
        }

        .theme-toggle:active { transform: scale(0.9); }

        .logout-btn-top {
            position: fixed;
            top: 15px;
            right: 70px; /* Positioned to the left of theme toggle */
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px var(--shadow);
            z-index: 1000;
            font-size: 20px;
            transition: transform 0.2s;
            color: var(--danger);
        }

        .logout-btn-top:active { transform: scale(0.9); }

        .header {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 600px;
            justify-content: center;
            margin-top: 50px;
        }

        .login-btn {
            background-color: var(--bg-input);
            color: var(--text-main);
            padding: 12px 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            flex: 1;
            min-width: 140px;
            transition: transform 0.2s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .login-btn:active { transform: scale(0.95); }
        .login-btn:hover { background-color: var(--secondary); }

        .search-container {
            width: 100%;
            max-width: 600px;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow);
            border: 1px solid var(--border);
        }

        h3 { margin-top: 0; font-weight: 500; color: var(--primary); font-size: 1.1rem; }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus { border-color: var(--primary); }

        .reset-btn-inline {
            background: var(--danger);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .results-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 12px;
            background: var(--bg-list);
        }

        .results-list li {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .results-list li:hover { background-color: rgba(255,255,255,0.05); }

        .results-list li .symbol { font-weight: bold; color: var(--primary); display: block; }
        .results-list li .name { font-size: 12px; color: var(--text-dim); }
        .results-list li .details { font-size: 11px; color: var(--text-details); display: block; margin-top: 4px; }

        .json-output {
            margin-top: 15px;
            padding: 15px;
            background-color: #000000;
            color: #ffffff;
            border-radius: 12px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            position: relative;
            border: 1px solid var(--border);
        }

        [data-theme="light"] .json-output {
            background-color: #f0f0f0;
            color: #000000;
            border-color: #ddd;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: var(--bg-card);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .hidden { display: none !important; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--text-details); border-radius: 10px; }

        @media (max-width: 480px) {
            .header { gap: 8px; }
            .login-btn { padding: 10px; font-size: 12px; min-width: 120px; }
        }

        /* PIN Modal Styles */
        #pin-modal, #change-pin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        #change-pin-modal {
            z-index: 10000;
        }

        .pin-container {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 40px var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .pin-inputs {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 25px 0;
        }

        .pin-input {
            width: 45px;
            height: 55px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            font-size: 24px;
            color: var(--text-main);
            outline: none;
            transition: border-color 0.2s, transform 0.2s;
            -webkit-text-security: disc; /* Masking */
        }

        .pin-input:focus {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .change-pin-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .change-pin-icon:hover { opacity: 1; }

        .modal-title {
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 20px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--bg-card);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .input-group {
            text-align: left;
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 5px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-main);
            box-sizing: border-box;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- PIN Verification Modal -->
    <div id="pin-modal">
        <div class="pin-container">
            <div class="change-pin-icon" onclick="openChangePinModal()" title="Change Password">‚öôÔ∏è</div>
            <div class="modal-title">Enter PIN</div>
            <div class="modal-subtitle">Security check required to access trading dashboard</div>
            <div class="pin-inputs">
                <input type="password" class="pin-input" maxlength="1" inputmode="numeric" oninput="handlePinInput(this, 0)" onkeydown="handlePinKeydown(event, 0)">
                <input type="password" class="pin-input" maxlength="1" inputmode="numeric" oninput="handlePinInput(this, 1)" onkeydown="handlePinKeydown(event, 1)">
                <input type="password" class="pin-input" maxlength="1" inputmode="numeric" oninput="handlePinInput(this, 2)" onkeydown="handlePinKeydown(event, 2)">
                <input type="password" class="pin-input" maxlength="1" inputmode="numeric" oninput="handlePinInput(this, 3)" onkeydown="handlePinKeydown(event, 3)">
                <input type="password" class="pin-input" maxlength="1" inputmode="numeric" oninput="handlePinInput(this, 4)" onkeydown="handlePinKeydown(event, 4)">
                <input type="password" class="pin-input" maxlength="1" inputmode="numeric" oninput="handlePinInput(this, 5)" onkeydown="handlePinKeydown(event, 5)">
            </div>
            <div id="pin-error" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px; display: none;">Invalid PIN. Please try again.</div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="change-pin-modal" class="hidden">
        <div class="pin-container">
            <div class="modal-title">Change PIN</div>
            <div class="modal-subtitle">Update your 6-digit access security PIN</div>
            
            <div class="input-group">
                <label>Current PIN</label>
                <input type="password" id="current-pin-input" placeholder="Enter current 6-digit PIN" maxlength="6">
            </div>
            
            <div class="input-group">
                <label>New PIN</label>
                <input type="password" id="new-pin-input" placeholder="Enter new 6-digit PIN" maxlength="6">
            </div>

            <button class="btn-primary" onclick="submitChangePin()">Update PIN</button>
            <button class="btn-secondary" onclick="closeChangePinModal()">Cancel</button>
            
            <div id="change-pin-message" style="margin-top: 15px; font-size: 0.8rem; display: none;"></div>
        </div>
    </div>

    <div class="theme-toggle" id="theme-toggle" title="Toggle Theme">‚òÄÔ∏è</div>
    <div class="logout-btn-top" id="logout-btn" onclick="logout()" title="Logout">üö™</div>

    <div class="header">
        <button class="login-btn" onclick="redirectToLogin()">üîê Login Upstox</button>
        <button class="login-btn" style="border-left: 4px solid #ffffff;" onclick="restartService()">üîÑ Restart</button>
        <button class="login-btn" style="border-left: 4px solid var(--danger);" onclick="stopService()">‚èπÔ∏è Stop</button>
    </div>

    <div class="search-container">
        <h3>üîç Asset Search</h3>
        <div class="search-box">
            <input type="text" id="search-input" placeholder="RELIANCE, NIFTY..." oninput="searchInstruments()">
            <button class="reset-btn-inline" onclick="resetSearch()" title="Reset Search">üîÑ</button>
        </div>
        <ul id="results-list" class="results-list hidden"></ul>

        <div id="json-container" class="hidden">
            <h4 style="margin-bottom: 10px; color: var(--text-dim); font-size: 14px;">üìã Trading View Message</h4>
            <div class="json-output" id="json-output"></div>
            <p style="font-size: 11px; color: var(--text-details); margin-top: 10px;">Paste this into your TradingView Alert Message.</p>
        </div>
    </div>

    <script>
        // PIN Authentication Logic
        const pinInputs = document.querySelectorAll('.pin-input');
        const pinModal = document.getElementById('pin-modal');
        const changePinModal = document.getElementById('change-pin-modal');
        const pinError = document.getElementById('pin-error');

        // Auto-focus first input on load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                pinInputs[0].focus();
            }, 100);
        });

        function handlePinInput(input, index) {
            // Only allow numbers
            input.value = input.value.replace(/[^0-9]/g, '');

            if (input.value.length === 1) {
                if (index < 5) {
                    pinInputs[index + 1].focus();
                } else {
                    // Last digit entered, verify PIN
                    verifyPin();
                }
            }
        }

        function handlePinKeydown(event, index) {
            if (event.key === 'Backspace' && !pinInputs[index].value && index > 0) {
                pinInputs[index - 1].focus();
            }
        }

        async function verifyPin() {
            const pin = Array.from(pinInputs).map(i => i.value).join('');
            if (pin.length !== 6) return;

            try {
                const response = await fetch(`/api/verify-pin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    pinModal.style.opacity = '0';
                    setTimeout(() => {
                        pinModal.classList.add('hidden');
                    }, 300);
                } else {
                    pinError.style.display = 'block';
                    // Clear inputs and refocus
                    pinInputs.forEach(i => i.value = '');
                    pinInputs[0].focus();
                    setTimeout(() => { pinError.style.display = 'none'; }, 3000);
                }
            } catch (err) {
                console.error('PIN Verification failed:', err);
                alert('Connection error. Please check if backend is running.');
            }
        }

        function openChangePinModal() {
            changePinModal.classList.remove('hidden');
        }

        function logout() {
            // Show PIN modal again
            pinModal.classList.remove('hidden');
            pinModal.style.opacity = '1';
            // Clear inputs
            pinInputs.forEach(i => i.value = '');
            // Focus first input
            setTimeout(() => pinInputs[0].focus(), 100);
        }

        function closeChangePinModal() {
            changePinModal.classList.add('hidden');
            document.getElementById('current-pin-input').value = '';
            document.getElementById('new-pin-input').value = '';
            document.getElementById('change-pin-message').style.display = 'none';
        }

        async function submitChangePin() {
            const currentPin = document.getElementById('current-pin-input').value;
            const newPin = document.getElementById('new-pin-input').value;
            const messageEl = document.getElementById('change-pin-message');

            if (currentPin.length !== 6 || newPin.length !== 6) {
                messageEl.textContent = 'Both PINs must be 6 digits.';
                messageEl.style.color = 'var(--danger)';
                messageEl.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`/api/change-pin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPin, newPin })
                });

                const result = await response.json();

                if (response.ok) {
                    messageEl.textContent = '‚úÖ PIN updated successfully!';
                    messageEl.style.color = 'var(--success)';
                    messageEl.style.display = 'block';
                    setTimeout(closeChangePinModal, 2000);
                } else {
                    messageEl.textContent = '‚ùå ' + (result.error || 'Failed to update PIN');
                    messageEl.style.color = 'var(--danger)';
                    messageEl.style.display = 'block';
                }
            } catch (err) {
                messageEl.textContent = '‚ùå Connection error';
                messageEl.style.color = 'var(--danger)';
                messageEl.style.display = 'block';
            }
        }

        // Theme Toggle Logic
        const themeToggle = document.getElementById('theme-toggle');
        const currentTheme = localStorage.getItem('theme') || 'dark';

        if (currentTheme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
            themeToggle.innerText = 'üåô';
        }

        themeToggle.addEventListener('click', () => {
            let theme = document.documentElement.getAttribute('data-theme');
            if (theme === 'light') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
                themeToggle.innerText = '‚òÄÔ∏è';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                themeToggle.innerText = 'üåô';
            }
        });

        // Register Service Worker for PWA with auto-refresh logic
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(reg => {
                    console.log('SW Registered!', reg);
                    reg.update();
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload();
                            }
                        };
                    };
                }).catch(err => {
                    console.log('SW Registration failed!', err);
                });
            });

            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    window.location.reload();
                    refreshing = true;
                }
            });
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.ready.then(reg => reg.update());
                }
            }
        });

        const BACKEND_URL = 'https://shiv-websocket.onrender.com';
        const WEBHOOK_SECRET = 'shiv'; 

        function redirectToLogin() {
            const returnUrl = encodeURIComponent(window.location.origin);
            window.location.href = `${BACKEND_URL}/auth/login?return_url=${returnUrl}`;
        }

        async function restartService() {
            if (!confirm('Restart the service?')) return;
            try {
                const response = await fetch(`${BACKEND_URL}/service/restart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) alert('‚úÖ Service restart initiated.');
                else alert('‚ùå Failed to restart');
            } catch (err) { alert('‚ùå Error: ' + err.message); }
        }

        async function stopService() {
            if (!confirm('Stop the service?')) return;
            try {
                const response = await fetch(`${BACKEND_URL}/service/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) alert('‚úÖ Service stopped.');
                else alert('‚ùå Failed to stop');
            } catch (err) { alert('‚ùå Error: ' + err.message); }
        }

        let searchTimeout;

        function resetSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('results-list').classList.add('hidden');
            document.getElementById('json-container').classList.add('hidden');
        }

        async function searchInstruments() {
            const query = document.getElementById('search-input').value;
            const list = document.getElementById('results-list');
            
            if (query.length < 2) {
                list.classList.add('hidden');
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const results = await response.json();
                    
                    list.innerHTML = '';
                    if (results.length > 0) {
                        results.forEach(inst => {
                            const li = document.createElement('li');
                            const detailStr = `${inst.exchange} | ${inst.instrument_type} ${inst.expiry ? '| ' + inst.expiry : ''}`;
                            li.innerHTML = `
                                <div>
                                    <span class="symbol">${inst.trading_symbol}</span>
                                    <span class="name">${inst.name || ''}</span>
                                </div>
                                <span class="details">${detailStr}</span>
                            `;
                            li.onclick = () => selectInstrument(inst);
                            list.appendChild(li);
                        });
                        list.classList.remove('hidden');
                    } else {
                        list.classList.add('hidden');
                    }
                } catch (err) { console.error('Search error:', err); }
            }, 300);
        }

        function selectInstrument(inst) {
            document.getElementById('search-input').value = inst.trading_symbol;
            document.getElementById('results-list').classList.add('hidden');
            
            const json = {
                "token": WEBHOOK_SECRET,
                "symbol": `${inst.exchange}:${inst.trading_symbol}`,
                "action": "BUY",
                "quantity": 1,
                "price": "{{close}}"
            };

            const output = document.getElementById('json-output');
            output.innerHTML = `<button class="copy-btn" onclick="copyToClipboard()">Copy</button>` + JSON.stringify(json, null, 4);
            document.getElementById('json-container').classList.remove('hidden');
        }

        function copyToClipboard() {
            const text = document.getElementById('json-output').innerText.replace('Copy', '');
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.innerText = 'Copied!';
                setTimeout(() => btn.innerText = 'Copy', 2000);
            });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            fetch('/set-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token })
            }).then(() => {
                window.history.replaceState({}, document.title, window.location.pathname);
            });
        }
    </script>
</body>
</html>
